<!DOCTYPE html>
<html lang="en">
  <head>
  {{> sections/head}}
  </head>
  <body>
    {{> sections/header}}
    <div id="main">
      <div class="container">
        <div class="section-header">
          <h1 class="punchline">Manage Users</h1>
        </div>      
<!--         <div class="lecturer-details row">
          <div class="col-sm-6 col-lg-8">
            <div class="description">Manage users</div>
          </div>
        </div>
        <h2 class="lecturer-courses">Users</h2> -->
        {{=<% %>=}}
        <div id="users" class="row">
          <div class="col-sm-12">
            <table class="table table-striped">
                <thead class="thead-inverse">
                  <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>User Role</th>
                    <th>Confirmed</th>
                    <th>Suspended</th>
                    <th>Edit</th>
                    <th>Delete</th>
                  </tr>
                </thead>
                <tbody>                
                  <tr v-for="user in users">
                    <td>{{user.id}}</td>
                    <td>{{user.username}}</td>
                    <td>{{user.email}}</td>
                    <td>{{user.first_name}}</td>
                    <td>{{user.last_name}}</td>
                    <td>{{user.role && user.role.name}}</td>                    
                    <td>yes</td>
                    <td>no</td>
                    <td><a href="#" data-action="edit-user" v-bind:data-user="user.username" class="icon-edit">Edit</a></td>
                    <td><a href="#" data-action="remove-user" v-bind:data-user="user.username" class="icon-remove" v-on:click="deleteUserModal">Delete</a></td>
                  </tr>                
                <!-- {{/users}} -->
                </tbody>
            </table>
            
            <!-- Modal -->
            
            <div class="modal fade" id="edit-modal" tabindex="-1" role="dialog" aria-labelledby="edit-modal-title" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="edit-modal-title">Confirm action</h4>
                  </div>
                  <div class="modal-body">
                    Delete user <strong>{{username}}</strong>?
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-alert" v-on:click="deleteUser">Delete</button>
                  </div>
                </div>
              </div>
            </div>
            <%={{ }}=%>            
          </div>
        </div>
      </div>
    </div>
    {{> components/csrf}}
    {{> sections/scripts}}
    <script type="text/javascript">
    (function($){

      window.csrf = (function(){
        var secret;
        var fetch = function(){
          var name = $('#csrf-name'),
              value = $('#csrf-value'),
              csrf = {};          
          csrf[name.attr('name')] = name.val();
          csrf[value.attr('name')] = value.val();
          return csrf;
        };
        var fn = function(data){
          var csrf = secret || fetch();
          data = data || {};
          return $.extend({}, data, csrf);           
        };
        fn.set = function(data){
          var csrf = {};
          csrf[data.tokenNameKey] = data.tokenName;
          csrf[data.tokenValueKey] = data.tokenValue;
          secret = csrf;
        };
        return fn;
      })();

      var vm = new Vue({
        el: '#users',
        created: function () {
          $.ajax({
            method : "POST",
            data : csrf(),
            success : this.updateUsers
          });
        },
        data: {
          username : '',
          users: []
        },
        methods: {
          updateUsers : function(data){
            this.users = data.users;
            csrf.set(data.csrf);
            console.log(data);
          },
          deleteUserModal : function(e){
            this.username = $(e.target).data('user');
            $('#edit-modal').modal();
          },
          deleteUser : function(e){
            console.log(this.username);
            $.ajax({
              method : "POST",
              url :  window.location.pathname + "/delete",
              data : csrf({username : this.username}),
              success : this.updateUsers
            });
          }
        }
      });

      // $.ajax({
      //   method : "POST",
      //   url : window.location.pathname,
      //   data : csrf(),
      //   success : function(data){
      //     vm.users.list = data;
      //   }
      // });

      
      // var deleteUser = function(user){
      //   $.ajax({
      //     method : "POST",
      //     url : window.location.pathname + '/delete',
      //     data : { 
      //       'username' : user
      //     }
      //   });
      // };

    })(jQuery)
    </script>
  </body>
</html>